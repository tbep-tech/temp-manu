---
title: "GAM exploration"
format: 
  html:
    code-fold: true
    toc: true
    code-tools: true
editor: visual

filters:
   - lightbox
lightbox: auto

execute:
  warning: false
  message: false
  eval: true
---

```{r}
library(tidyverse)
library(mgcv)
library(gratia)
library(patchwork)
library(here)
library(broom)
library(knitr)

source(here('R/funcs.R'))

load(file = here('data/epccmbdat.RData'))
load(file = here('data/fimsgtempdat.RData'))
load(file = here('data/pincotemp.RData'))
```

The following is an exploratory analysis of potential seagrass response related to time, light attenuation, temperature, and salinity. Three different datasets are used, each with different sampling designs. GAMs are used to assess potential non-linear responses in seagrass change using the sum of additive smoothing functions for different predictors. Lower Tampa Bay is not modeled in any of the models given minimal seagrass loss. Model selection techniques are not considered for simplicity and the results are evaluated based on the percent deviance explained and "partial effects" of each smoother, where the smoother is a proxy for the effect of the variable on the response while considering a more comprehensive set of predictors.

## Quick summary

All models had much more explained variance (32-94%) compared to earlier linear regression models. The EPC models returned confusing results, which could be from differences in sampling location for water quality (mid-bay) vs seagrass transect sampling. The FIM models for nearshore provide the most compelling results, particularly for temperature in HB and salinity in MTB. There are also some notable differences by season in the FIM models. The PDEM models are inconsistent, although a significant interaction term for temperature and season at stratum E4 (most southern portion of OTB) suggests increasing temperature in the winter is associated with lower seagrass frequency occurrence. In general, trends in OTB are not explained well by temperature or salinity, whereas HB and MTB follow expectations for some of the models.

## EPC

The EPC data were compared to bay segment averages of seagrass transect frequency occurrence data at the annual scale. Light attenuation was estimated from all monitoring stations using Secchi depth and combined as a bay segment average, as is done for TBEP reporting to FDEP. Temperature and salinity are expressed as the estimated number of days each year when when temperature was above or salinity was below a threshold, where the expectation is that total frequency occurrence will decrease as both increase. The model formula is as follows:

$$
\begin{aligned}
Freq. Occ. \sim s(year, by = bay\_segment, bs = 'tp') + s(la, by = bay\_segment, bs = 'tp') + 
\\
s(temp, by = bay\_segment, bs = 'tp') + s(salinity, by = bay\_segment, bs = 'tp')
\end{aligned}
$$

```{r}
tomod <- epccmbdat %>% 
  filter(!bay_segment %in% c('LTB'))

##
# single smoothers only, temp, sal

mod <- gam(total ~ s(yr, by = bay_segment) + s(la, by = bay_segment) + s(temp, by = bay_segment) + s(sal, by = bay_segment), data = tomod, method = 'REML')
```

Smoother summary:

```{r}
mod %>% 
  tidy() %>% 
  mutate(
    star = p_ast2(p.value)
  ) %>% 
  kable(digits = 3)
```

Model fit summary:

```{r}
smmod <- summary(mod)
smtab <- tibble(
  R.sq = smmod$r.sq,
  `Deviance explained` = paste0(round(100*smmod$dev.expl, 0), '%')
)
kable(smtab, digits = 2, align = 'l')
```

```{r}
#| fig-width: 8
#| fig-height: 10
draw(mod, ncol = 3)
```

The same model is created but the "both" metric is used instead of temperature and salinity, which is the number of days each year when both temperature was above or salinity was below thresholds. The expectation is that total frequency occurrence will decrease as the metric increases, either linearly (additive effect) or non-linearly (multiplicative effect). The model formula is as follows:

$$
\begin{aligned}
Freq. Occ. \sim s(year, by = bay\_segment, bs = 'tp') + s(la, by = bay\_segment, bs = 'tp') + 
\\
s(both, by = bay\_segment, bs = 'tp')
\end{aligned}
$$

```{r}
##
# single smoothers only, temp, sal

mod <- gam(total ~ s(yr, by = bay_segment) + s(la, by = bay_segment) + s(both, by = bay_segment), data = tomod, method = 'REML')
```

Smoother summary:

```{r}
mod %>% 
  tidy() %>% 
  mutate(
    star = p_ast2(p.value)
  ) %>% 
  kable(digits = 3)
```

Model fit summary:

```{r}
smmod <- summary(mod)
smtab <- tibble(
  R.sq = smmod$r.sq,
  `Deviance explained` = paste0(round(100*smmod$dev.expl, 0), '%')
)
kable(smtab, digits = 2, align = 'l')
```

```{r}
#| fig-width: 8
#| fig-height: 7.5
draw(mod, ncol = 3)
```

### Conclusions

There's some weirdness with these models that don't align with expectations. For example, increasing light attenuation is associated with increasing seagrass frequency occurrence (MTB). Additionally, increases of the stressor metrics are also often associated with increasing seagrass frequency occurrence. These results could be from a discrepancy between sampling location of the EPC stations and the seagrass transects, i.e., the stations are in deeper water and may not reflect conditions at the seagrass beds in more shallow waters. The association of the salinity metric with seagrasses in MTB is as expected, although the smoother is not significant. However, this is consistent with the FIM models.

## FIM

The FIM models are different from the EPC models in several ways:

-   Seagrass and stressor data are collected at the same locations possibly allowing for a more consistent comparison
-   The stressor data (light attenuation, temperature, salinity) are observed data, so the expectation of how seagrass will response varies from the EPC data and by stressor, i.e., seagrass will decrease with temperature and light attenuation, but increase with salinity (fresh conditions are more stressful)
-   Monthly observations are available, allowing a seasonal component in the model.
-   Secchi data is used for light attenuation (as for EPC), but more than half of the observations are on the bottom. Attempts were made to calculate monthly medians using Kaplan-Meier survival curves, but data were insufficient to do so.

The FIM data are averaged at the annual and monthly time steps. The model is more complex than the previous and includes smoothers for year, month, light attenuation, temperature, and salinity and interaction smoothers (`ti`) for the predictions with month, allowing the effects of the predictors to vary seasonally. Different smoothers are also constructed for each bay segment. The model formula is as follows:

$$
\begin{aligned}
Coverage \sim s(year, by = bay\_segment, bs = 'tp') + s(la, by = bay\_segment, bs = 'tp') + 
\\
s(temp, by = bay\_segment, bs = 'tp') + s(salinity, by = bay\_segment, bs = 'tp') +
\\
s(month, bs = 'cc', by = bay\_segment) + 
\\
ti(year, month, bs = c('tp', 'cc'), by = bay\_segment) + 
\\
ti(la, month, bs = c('tp', 'cc'), by = bay\_segment) + 
\\
ti(temp, month, bs = c('tp', 'cc'), by = bay\_segment) +
\\
ti(salinity, month, bs = c('tp', 'cc'), by = bay\_segment)
\end{aligned}
$$

```{r}
tomod <- fimsgtempdat %>% 
  filter(!bay_segment %in% c('LTB')) %>% 
  select(date, sgcov, sgpres, yr, temp, sal, secchi_m, secchi_on_bottom, bay_segment) %>% 
  na.omit() %>%
  mutate(mo = month(date)) %>% 
  # filter(month(date) %in% c(6:9)) %>%
  summarise(
    sgcov = mean(sgcov),
    sgpres = mean(sgpres),
    temp = mean(temp),
    sal = mean(sal),
    secchi_m = mean(secchi_m),
    .by = c(bay_segment, yr, mo)
  ) %>% 
  mutate(
    la = dplyr::case_when(
      bay_segment %in% "OTB" ~ 1.49 / secchi_m,
      bay_segment %in% "HB" ~ 1.61 / secchi_m,
      bay_segment %in% "MTB" ~ 1.49 / secchi_m,
      bay_segment %in% "LTB" ~ 1.84 / secchi_m
    )
  )

mod <- gam(sgcov ~ s(yr, by = bay_segment) + s(la, by = bay_segment) + s(temp, by = bay_segment) + s(sal, by = bay_segment) + s(mo, bs = 'cc', by = bay_segment) + ti(yr, mo, bs = c('tp', 'cc'), by = bay_segment) + ti(la, mo, bs = c('tp', 'cc'), by = bay_segment) + ti(temp, mo, bs = c('tp', 'cc'), by = bay_segment) + ti(sal, mo, bs = c('tp', 'cc'), by = bay_segment), knots = list(doy = c(1, 12)), data = tomod, method = 'REML')
```

Smoother summary:

```{r}
mod %>% 
  tidy() %>% 
  mutate(
    star = p_ast2(p.value)
  ) %>% 
  kable(digits = 3)
```

Model fit summary:

```{r}
smmod <- summary(mod)
smtab <- tibble(
  R.sq = smmod$r.sq,
  `Deviance explained` = paste0(round(100*smmod$dev.expl, 0), '%')
)
kable(smtab, digits = 2, align = 'l')
```

Select smoothers:

```{r}
#| fig-width: 8
#| fig-height: 3
draw(mod, select = 's(temp)', ncol = 3, partial_match = TRUE)
draw(mod, select = 's(sal)', ncol = 3, partial_match = TRUE)
```

```{r}
#| fig-width: 10
#| fig-height: 4
draw(mod, select = 'ti(temp,mo)', ncol = 3, partial_match = TRUE)
draw(mod, select = 'ti(sal,mo)', ncol = 3, partial_match = TRUE)
```

Model slices for interaction terms:

```{r}
#| fig-width: 7
#| fig-height: 3
tempslc <- smooth_estimates(mod, select = 'ti(temp,mo)', partial_match = T) %>% 
  add_confint() %>% 
  filter(mo %in% c(1, 7)) %>% 
  filter(bay_segment %in% c('HB', 'MTB'))
ggplot(tempslc, aes(x = temp, y = .estimate, color = factor(mo), fill = factor(mo), group = mo)) +
  geom_ribbon(aes(ymin = .lower_ci, ymax = .upper_ci), alpha = 0.2, color = NA) +
  geom_line() +
  facet_wrap(~bay_segment, scales = 'free_y') + 
  labs(
    x = 'Temperature',
    y = 'Partial effect',
    color = 'Month',
    fill = 'Month'
  )
```

```{r}
#| fig-width: 4
#| fig-height: 3
salslc <- smooth_estimates(mod, select = 'ti(sal,mo)', partial_match = T) %>% 
  add_confint() %>% 
  filter(mo %in% c(3, 9)) %>% 
  filter(bay_segment %in% c('MTB'))
ggplot(salslc, aes(x = sal, y = .estimate, color = factor(mo), fill = factor(mo), group = mo)) +
  geom_ribbon(aes(ymin = .lower_ci, ymax = .upper_ci), alpha = 0.2, color = NA) +
  geom_line() +
  facet_wrap(~bay_segment, scales = 'free_y') + 
  labs(
    x = 'Salinity',
    y = 'Partial effect',
    color = 'Month',
    fill = 'Month'
  )
```

### Conclusions

The FIM models are more promising as expected relationships with temperature and salinity are observed, particularly for MTB and HB. There are also interesting interactions by month suggesting the effects vary seasonally, e.g., the temperature effect in HB seems to be driven by July temperatures and the salinity effect in MTB seems to be pronounced in the dry season (March).

## PDEM

The PDEM models are similar to the FIM models except only OTB is evaluated. Effects are also evaluated differently for four sampling strata in OTB (E1-E4, somewhat north to south), allowing for a more precise spatial assessment of seagrass relationships. The data are averaged for each year, month, and stratum. Compared to the FIM data, fewer Secchi measurements were on the bottom given the broader depth coverage (see Figure 1 in the manuscript). Additionally, PDEM only records seagrass presence/absence, but this was converted to a strata-wide frequency occurrence metric as the number of points with seagrass divided by the total points in each stratum.

The PDEM model is the same as for FIM, except separate smoothers are estimated for each stratum instead of bay segment. The model formula is as follows:

$$
\begin{aligned}
Freq. Occ. \sim s(year, by = stratum, bs = 'tp') + s(la, by = stratum, bs = 'tp') + 
\\
s(temp, by = stratum, bs = 'tp') + s(salinity, by = stratum, bs = 'tp') +
\\
s(month, bs = 'cc', by = stratum) + 
\\
ti(year, month, bs = c('tp', 'cc'), by = stratum) + 
\\
ti(la, month, bs = c('tp', 'cc'), by = stratum) + 
\\
ti(temp, month, bs = c('tp', 'cc'), by = stratum) +
\\
ti(salinity, month, bs = c('tp', 'cc'), by = stratum)
\end{aligned}
$$

```{r}

tomod <- pincotemp %>% 
  filter(!bay_segment %in% c('LTB')) %>% 
  select(date, allsg, yr, site, temp, sal, secchi_m, secchi_on_bottom, bay_segment) %>% 
  na.omit() %>%
  mutate(
    mo = month(date),
    site = factor(site)
    ) %>% 
  summarise(
    allsg = sum(allsg) / length(allsg),
    temp = mean(temp),
    sal = mean(sal),
    secchi_m = mean(secchi_m),
    .by = c(yr, mo, site)
  ) %>% 
  mutate(
    la = 1.49 / secchi_m
  )

mod <- gam(allsg ~ s(yr, by = site) + s(la, by = site) + s(temp, by = site) + s(sal, by = site) + s(mo, bs = 'cc', by = site) + ti(yr, mo, bs = c('tp', 'cc'), by = site) + ti(la, mo, bs = c('tp', 'cc'), by = site) + ti(temp, mo, bs = c('tp', 'cc'), by = site) + ti(sal, mo, bs = c('tp', 'cc'), by = site), knots = list(doy = c(1, 12)), data = tomod, method = 'REML')
```

Smoother summary:

```{r}
mod %>% 
  tidy() %>% 
  mutate(
    star = p_ast2(p.value)
  ) %>% 
  kable(digits = 3)
```

Model fit summary:

```{r}
smmod <- summary(mod)
smtab <- tibble(
  R.sq = smmod$r.sq,
  `Deviance explained` = paste0(round(100*smmod$dev.expl, 0), '%')
)
kable(smtab, digits = 2, align = 'l')
```

Select smoothers:

```{r}
#| fig-width: 8
#| fig-height: 3
draw(mod, select = 's(temp)', ncol = 4, partial_match = TRUE)
draw(mod, select = 's(sal)', ncol = 4, partial_match = TRUE)
```

```{r}
#| fig-width: 10
#| fig-height: 4
draw(mod, select = 'ti(temp,mo)', ncol = 4, partial_match = TRUE)
draw(mod, select = 'ti(sal,mo)', ncol = 4, partial_match = TRUE)
```

Model slices for interaction terms:

```{r}
#| fig-width: 7
#| fig-height: 3
tempslc <- smooth_estimates(mod, select = 'ti(temp,mo)', partial_match = T) %>% 
  add_confint() %>% 
  filter(mo %in% c(1, 7)) %>% 
  filter(site %in% c('E1', 'E4'))
ggplot(tempslc, aes(x = temp, y = .estimate, color = factor(mo), fill = factor(mo), group = mo)) +
  geom_ribbon(aes(ymin = .lower_ci, ymax = .upper_ci), alpha = 0.2, color = NA) +
  geom_line() +
  facet_wrap(~site, scales = 'free_y') + 
  labs(
    x = 'Temperature',
    y = 'Partial effect',
    color = 'Month',
    fill = 'Month'
  )
```

```{r}
#| fig-width: 4
#| fig-height: 3
salslc <- smooth_estimates(mod, select = 'ti(sal,mo)', partial_match = T) %>% 
  add_confint() %>% 
  filter(mo %in% c(3, 9)) %>% 
  filter(site %in% c('E4'))
ggplot(salslc, aes(x = sal, y = .estimate, color = factor(mo), fill = factor(mo), group = mo)) +
  geom_ribbon(aes(ymin = .lower_ci, ymax = .upper_ci), alpha = 0.2, color = NA) +
  geom_line() +
  facet_wrap(~site, scales = 'free_y') + 
  labs(
    x = 'Salinity',
    y = 'Partial effect',
    color = 'Month',
    fill = 'Month'
  )
```

### Conclusions

None of the main effects for temperature or salinity are significant, although Some of the interaction terms by stratum are informative. The model slices for salinity at stratum E4 and temperature at E1 are unclear, but temperature at E4 is associated with lower frequency occurrence of seagrass in January.
